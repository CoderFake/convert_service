{% extends 'web/layouts/base.html' %}
{% load static %}
{% load i18n %}
{% block title %} Dashboard {% endblock title %}

{% block stylesheets %}
    <link rel="stylesheet" type="text/css"
          href="{% static 'web/vendor/datatables.net/css/dataTables.bootstrap5.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'web/css/drag-drop-file.css' %}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .table-responsive {
            padding-bottom: 20px !important;
        }

        table.dataTable th,
        table.dataTable td {
            cursor: default;
        }

        table.dataTable .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 100px;
            max-width: 250px;
            display: inline-block;
            vertical-align: middle;
        }

        table.dataTable tbody tr td {
            min-height: 30px;
            height: 30px;
        }
        table.dataTable .truncate-text {
            text-overflow: clip !important;
        }

        #loadingRow td, #endMessage td {
            min-height: 30px;
            height: 30px;
            line-height: 30px;
            vertical-align: middle;
        }

        table.dataTable tbody tr {
            min-height: 30px;
        }

        table.dataTable tbody tr td,
        table.dataTable tbody tr td .truncate-text {
            line-height: 30px;
            vertical-align: middle;
        }
         table.dataTable tbody tr td{
            padding: 0 5px;
         }

        .active-row {
            background-color: yellow !important;
        }

        .show-data label {
            text-wrap: nowrap !important;
        }

        .show-data .form-control {
            height: calc(1em + 1.25rem + 5px) !important;
        }

        .export {
            bottom: 30px;
            right: 30px;
        }

        input[type="radio"] {
            left: 35%;
            top: 50%;
            transform: translateY(-50%);
        }

        @media screen and (max-width: 576px) {
            .export {
                position: unset !important;
                width: 100%;
                display: flex;
                justify-content: center;
            }

            .btn-export {
                bottom: 25px;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #loadingRow {
            animation: fadeIn 0.3s ease-in-out;
        }

        #endMessage {
            animation: fadeIn 0.3s ease-in-out;
            background-color: #f8f9fa !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dataTables_scrollBody {
            overflow-x: auto !important;
            margin-bottom: 5px !important;
            resize: vertical;
            min-height: 200px;
            max-height: 80vh !important;
            position: relative;
            transition: height 0.2s ease;
        }

        .dataTables_scrollBody::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .dataTables_scrollBody::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dataTables_scrollBody::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .dataTables_scrollBody::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .dataTables_resize_handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background-color: transparent;
            cursor: ns-resize;
            z-index: 100;
        }

        .dataTables_resize_handle:hover,
        .dataTables_resize_handle:active {
            background-color: rgba(78, 115, 223, 0.3);
        }

        .dataTables_scrollBody.resize-active {
            border-bottom: 2px solid #4e73df;
        }

        .show-data {
            height: 100%;
            overflow-y: auto;
            padding-right: 5px;
        }

        .col-12.mt-4.w-100.overflow-hidden {
            transition: height 0.2s ease;
        }

        #resize-overlay {
            background-color: transparent;
        }

        #paginationInfo {
            display: none !important;
            margin-top: 8px;
            margin-bottom: 12px;
            text-align: right;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .dataTables_wrapper {
            width: 100%;
            overflow-x: auto;
        }
        .table-resize-handle {
            width: 100%;
            height: 10px;
            background-color: transparent;
            cursor: ns-resize;
            position: absolute;
            bottom: 20px !important;
            left: 0;
            z-index: 100;
        }

        .table-resize-handle:hover {
            background-color: rgba(78, 115, 223, 0.3);
        }
    </style>
{% endblock stylesheets %}

{% block content %}
    <!-- Page content -->
    <div class="container-fluid h-100 position-relative">
        {% if not request.user.is_authenticated %}
            <div class="wrapper demo-wrapper">
                <div class="typing-demo">
                    予約情報一括変換サービス
                </div>
            </div>
        {% else %}
            {% if tab and tab == "upload-file" %}
                <div class="container compact drag-drop-file reservation w-90">
                    <div class="header-section">
                        <h1 class="text-center text-dark font-weight-bold mt-3" style="font-size: 3rem;">
                            変換する予約情報ファイルの選択
                        </h1>
                    </div>
                    <div class="row">
                        <div class="col-lg-12 form-file w-100">
                            <form id="input-form" enctype="multipart/form-data" onsubmit="return false;">
                                {% csrf_token %}
                                <div class="drop-section">
                                    <div class="col-12 mt-5">
                                        <span>予約情報ファイルを選択</span>
                                        <span>ここにファイルをドラッグ＆ドロップしてください</span>
                                        <button class="file-selector btn-primary">ファイルを選択</button>
                                        <input type="file" name="files" class="file-selector-input" multiple/>
                                    </div>
                                    <div class="col">
                                        <div class="drop-here">ここにドロップ</div>
                                    </div>
                                </div>
                                <div class="list-section">
                                    <div class="col-12 mt-3 p-0">
                                        <div class="process w-100 d-flex flex-column flex-sm-row gap-5 align-items-center">
                                            <button type="submit"
                                                    class="btn-primary border-0 rounded p-2 pl-3 pr-3 ml-2 mr-2 submit-btn d-none">
                                                選択したファイルを一括変換
                                            </button>
                                            <div class="lds-roller d-none">
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                            </div>
                                            <div class="lds-roller ml-2 mr-2 d-none">
                                                <p class="mt-2 text-dark text-nowrap">変換中</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="list pb-5 mt-2"></div>
                                </div>
                            </form>
                        </div>
                        <div class="d-none show-file">
                            <div class="row">
                                <div class="spin w-100 h-100">
                                    <div id="Overlay" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {#                <div class="container compact drag-drop-file response w-90">#}
                {#                    <div class="header-section">#}
                {#                        <h1 class="text-center text-dark font-weight-bold">各施設様からの予約回答ファイルを一括変換</h1>#}
                {#                    </div>#}
                {#                    <div class="row">#}
                {#                        <div class="col-lg-12 form-file w-100">#}
                {#                            <form class="mt-2" id="input-form" enctype="multipart/form-data" onsubmit="return false;">#}
                {#                                {% csrf_token %}#}
                {#                                <div class="drop-section">#}
                {#                                    <div class="col-12 mt-5">#}
                {#                                        <span>予約回答ファイルを選択</span>#}
                {#                                        <span>ここにファイルをドラッグ＆ドロップしてください</span>#}
                {#                                        <button class="file-selector btn-primary">ファイルを選択</button>#}
                {#                                        <input type="file" name="files" class="file-selector-input" multiple/>#}
                {#                                    </div>#}
                {#                                    <div class="col">#}
                {#                                        <div class="drop-here">ここにドロップ</div>#}
                {#                                    </div>#}
                {#                                </div>#}
                {#                                <div class="list-section">#}
                {#                                    <div class="col-12 mt-3 p-0">#}
                {#                                        <div class="process w-100 d-flex flex-column flex-sm-row gap-5 align-items-center">#}
                {#                                            <button type="submit"#}
                {#                                                    class="btn-primary border-0 rounded p-2 pl-3 pr-3 ml-2 mr-2 submit-btn d-none">#}
                {#                                                選択したファイルを一括変換#}
                {#                                            </button>#}
                {#                                            <div class="lds-roller d-none">#}
                {#                                                <div></div>#}
                {#                                                <div></div>#}
                {#                                                <div></div>#}
                {#                                                <div></div>#}
                {#                                                <div></div>#}
                {#                                                <div></div>#}
                {#                                                <div></div>#}
                {#                                                <div></div>#}
                {#                                            </div>#}
                {#                                            <div class="lds-roller ml-2 mr-2 d-none">#}
                {#                                                <p class="mt-2 text-dark text-nowrap">変換中</p>#}
                {#                                            </div>#}
                {#                                        </div>#}
                {#                                    </div>#}
                {#                                    <div class="list pb-5 mt-2"></div>#}
                {#                                </div>#}
                {#                            </form>#}
                {#                        </div>#}
                {#                        <div class="d-none show-file">#}
                {#                            <div class="row">#}
                {#                                <div class="spin w-100 h-100">#}
                {#                                    <div id="Overlay" style="display:none;"></div>#}
                {#                                </div>#}
                {#                            </div>#}
                {#                        </div>#}
                {#                    </div>#}
                {#                </div>#}
            {% elif tab and tab == "process-file" %}
                <div class="row">
                    <div class="col-12 w-100">
                        <div class="table-header d-flex flex-row align-items-center w-100 mt-3">
                            <div class="text-header justify-content-start">
                                <i class="fas fa-check-circle text-primary"></i>
                                <span class="content text-dark font-weight-bold">解析完了</span>
                            </div>
                            <div class="justify-items-end d-flex" style="align-self: flex-end; margin-left: auto;">
                                <button class="btn btn-format-file btn-primary pr-3 pl-3 pt-1 pb-1 d-none">
                                    フォーマットを続ける
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive overflow-hidden mt-2">
                            <table id="inputData" class="table table-bordered w-100">
                                <thead class="bg-info">
                                <tr>
                                    {% for header in headers %}
                                        <th>{{ header }}</th>
                                    {% endfor %}
                                </tr>
                                </thead>
                                <tbody>
                                {% if processed_files %}
                                    {% for file in processed_files %}
                                        {% for row in file.data %}
                                            <tr>
                                                {% for cell in row %}
                                                    <td>{{ cell }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    {% endfor %}
                                {% endif %}
                                </tbody>
                            </table>
                            <div id="paginationInfo" class="d-none">0/0 行表示中</div>
                            <div class="table-resize-handle"></div>
                        </div>

                    </div>
                    <div class="col-12 mt-4 w-100 overflow-hidden" style="height: calc(100vh - 400px); max-height: 500px;">
                        <div class="show-data pr-0 mb-5 mb-sm-0 w-100 h-100" style="overflow-x: hidden !important;">
                        </div>
                    </div>
                </div>
                <div class="export position-fixed d-flex flex-column w-60">
                    <button id="system-csv" class="btn btn-export btn-primary m-0 mb-3 border-0">健診システム取り込みデータCSV出力</button>
                    <button id="agency-csv" class="btn btn-export btn-primary m-0 border-0">予約代行業者取り込みデータCSV出力</button>
                </div>

            {% endif %}
        {% endif %}
    </div>

{% endblock content %}

{% block javascripts %}
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    {% if tab == 'process-file' %}
        <script src="{% static 'web/vendor/datatables.net/js/jquery.dataTables.min.js' %}"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
        <script>
            $(document).ready(function () {
                let headerInfo = [];
                let currentPage = 1;
                let loading = false;
                let hasMoreData = true;
                let endMessageAdded = false;
                const PAGE_SIZE = 20;

                function loadProcessedFiles(page = 1, append = false) {
                    if (loading) return;

                    loading = true;

                    if (!append) {
                        $("#inputData tbody").html('<tr><td colspan="100%" class="text-center"><div class="loading-spinner"></div> データを読み込み中...</td></tr>');
                    } else {
                        $("#loadingRow").remove();
                        $("#inputData tbody").append('<tr id="loadingRow"><td colspan="100%" class="text-center"><div class="loading-spinner"></div> 追加データを読み込み中...</td></tr>');
                    }

                    $.ajax({
                        url: "{% url 'get_data' %}",
                        type: "POST",
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify({
                            page: page,
                            page_size: PAGE_SIZE
                        }),
                        success: function(response) {
                            loading = false;
                            $("#loadingRow").remove();

                            if (response.status === 'success') {
                                const processedData = response.data || [];
                                headerInfo = response.headers || [];

                                currentPage = response.pagination.page;
                                hasMoreData = currentPage < response.pagination.total_pages;

                                const table = $("#inputData");

                                if (!append) {
                                    if ($.fn.DataTable.isDataTable(table)) {
                                        table.DataTable().destroy();
                                    }

                                    const thead = table.find("thead");
                                    if (thead.length === 0) {
                                        table.prepend("<thead><tr></tr></thead>");
                                    }

                                    const headerRow = table.find("thead tr");
                                    headerRow.empty();
                                    headerInfo.forEach(header => {
                                        const headerClass = header.edit_value ? 'bg-success' : '';
                                        headerRow.append(`<th class="${headerClass}">${header.header_name || ''}</th>`);
                                    });

                                    table.find("tbody").empty();
                                    endMessageAdded = false;
                                }

                                const tbody = table.find("tbody");
                                if (tbody.length === 0) {
                                    table.append("<tbody></tbody>");
                                }
                                let rowsAdded = 0;
                                processedData.forEach(dataSet => {
                                    if (dataSet.data && Array.isArray(dataSet.data)) {
                                        dataSet.data.forEach((row, index) => {
                                            const rowKey = `${dataSet.key} ${index}`;
                                            const rowHTML = row.map((cell, cellIndex) => {
                                                const header = headerInfo[cellIndex];
                                                const cellClass = header?.edit_value
                                                    ? header.format_value === 'date' ? 'row-date'
                                                    : header.format_value === 'time' ? 'row-time'
                                                    : ''
                                                    : '';
                                                return `<td class="${cellClass} ${header?.header_name || ''}">${cell || ''}</td>`;
                                            }).join('');
                                            tbody.append(`<tr data-index="${rowKey}">${rowHTML}</tr>`);
                                            rowsAdded++;
                                        });
                                    }
                                });

                                if (headerInfo.length > 0 && !append) {
                                    try {
                                        initDataTable(table);
                                    } catch (error) {
                                        createToast("error", "テーブルの初期化中にエラーが発生しました。");
                                    }
                                } else if (append && rowsAdded > 0) {
                                    table.find('tbody tr').slice(-rowsAdded).find('td').addClass('dt-start');

                                    if ($.fn.DataTable.isDataTable(table)) {
                                        table.DataTable().columns.adjust();
                                    }
                                }

                                const currentRows = $("table#inputData tbody tr").length;
                                const totalRows = response.pagination.total_rows;
                                $("#paginationInfo").html(`${currentRows}/${totalRows} 行表示中`);

                                if (rowsAdded > 0) {
                                    checkIfMoreContentNeeded();
                                }

                            } else {
                                createToast("error", response.message || "データの取得に失敗しました。");
                            }
                        },
                        error: function (error) {
                            loading = false;
                            $("#loadingRow").remove();
                            createToast("error", "エラーが発生しました。データを取得できませんでした。");
                        }
                    });
                }

                function initDataTable(idTable) {
                    $('.table-responsive').css('height', '220px');

                    if ($.fn.DataTable.isDataTable(idTable)) {
                        idTable.DataTable().destroy();
                    }

                    const dataTable = idTable.DataTable({
                        scrollY: "220px",
                        scrollX: true,
                        scrollCollapse: true,
                        paging: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        lengthChange: false,
                        columnDefs: [
                            {
                                targets: '_all',
                                className: 'dt-start',
                                render: function(data, type, row) {
                                    const displayData = data || '';
                                    return `<div class="truncate-text" title="${displayData}">${displayData}</div>`;
                                }
                            }
                        ],
                        language: {
                            url: "{% static 'web/vendor/datatables.net/language/ja.json' %}"
                        },
                        fixedHeader: true,
                        autoWidth: true,
                        initComplete: function(settings, json) {
                            this.api().columns.adjust();

                            $(".dataTables_scrollBody").css("overflow-x", "auto");
                            setInterval(function (){
                               $('.table-responsive').css('height', 'auto');
                            }, 500)

                            $(".dataTables_scrollBody").css({"height": "220px", "min-height": "220px"});
                            setupScrollEvents();
                        }
                    });

                    return dataTable;
                }

                function setupScrollEvents() {

                    const scrollBodySelector = ".dataTables_scrollBody";

                    $(scrollBodySelector).off("scroll.infiniteScroll");

                    $(scrollBodySelector).on("scroll.infiniteScroll", function() {

                        const scrollTop = $(this).scrollTop();
                        const viewportHeight = $(this).height();
                        const scrollHeight = $(this)[0].scrollHeight;

                        const denominator = Math.max(1, scrollHeight - viewportHeight);
                        const scrollPercent = (scrollTop / denominator) * 100;

                        if (!loading && hasMoreData && scrollPercent >= 80 && !endMessageAdded) {
                            currentPage++;
                            loadProcessedFiles(currentPage, true);
                        }
                    });

                    setTimeout(function() {
                        checkIfMoreContentNeeded();
                    }, 300);
                }

                function checkIfMoreContentNeeded() {
                    const scrollBody = $(".dataTables_scrollBody");
                    if (scrollBody.length > 0) {
                        const scrollHeight = scrollBody[0].scrollHeight;
                        const clientHeight = scrollBody.height();

                        if (scrollHeight <= clientHeight && hasMoreData && !loading && !endMessageAdded) {
                            console.log("Auto loading more because content is not enough to scroll");
                            setTimeout(function() {
                                currentPage++;
                                loadProcessedFiles(currentPage, true);
                            }, 300);
                        }
                    }
                }

                $(window).on('resize', function() {
                    if ($.fn.DataTable.isDataTable("#inputData")) {
                        $("#inputData").DataTable().columns.adjust();
                    }
                });

                loadProcessedFiles();

                $('#inputData').on('click', 'tbody tr', function () {

                    if ($(this).attr('id') === 'endMessage' || $(this).attr('id') === 'loadingRow') {
                        return;
                    }

                    $('#inputData tbody tr').removeClass('active-row');

                    $(this).addClass('active-row');

                    const cells = $(this).find('td').map(function () {
                        return $(this).text();
                    }).get();

                    const formattedKey = $(this).data('index');
                    const showDataDiv = $('.show-data');
                    showDataDiv.empty();
                    showDataDiv.attr('data-index', formattedKey);

                    let rowHTML = '<div class="row">';
                    let colLeft1 = '<div class="col-12 col-xl-6 col-lg-12 col-sm-12 d-flex flex-column justify-content-start">';
                    let colLeft2 = '<div class="col-12 col-xl-6 col-lg-12 col-sm-12 d-flex flex-column justify-content-start">';
                    let colRight = '<div class="col-12 col-xl-12 col-lg-12 col-sm-12 d-flex flex-column justify-content-start align-items-center">';

                    let nonEditHeaders = [];
                    let editHeaders = [];
                    headerInfo.forEach((header, index) => {
                        if (!header.edit_value) {
                            nonEditHeaders.push({ header: header.header_name, cell: cells[index] });
                        } else {
                            editHeaders.push({ header: header.header_name, cell: cells[index], format: header.format_value });
                        }
                    });

                    const midpoint = Math.ceil(nonEditHeaders.length / 2);
                    nonEditHeaders.forEach((item, index) => {
                        let content;
                        const regex = /第\d+希望日付/;
                        if (regex.test(item.header) && item.cell) {
                            content = `
                                <div class="mb-3 d-flex align-items-center w-100 position-relative">
                                    <label class="p-2 text-center text-truncate d-flex justify-content-center align-items-center m-0 mr-2 w-50 bg-info h-100" style="border-radius: 0.25rem;">${item.header}</label>
                                    <input type="radio" name="preferred-date" class="position-absolute">
                                    <input type="text" class="form-control bg-white pl-4" value="${item.cell || ''}" readonly>
                                </div>
                            `;
                        } else {
                            content = `
                                <div class="mb-3 d-flex align-items-center w-100">
                                    <label class="text-center text-truncate d-flex justify-content-center align-items-center m-0 mr-2 w-50 bg-info h-100" style="border-radius: 0.25rem;">${item.header}</label>
                                    <input type="text" id="${item.header}" class="form-control bg-white" value="${item.cell || ''}" readonly>
                                </div>
                            `;
                        }
                        if (index < midpoint) {
                            colLeft1 += content;
                        } else {
                            colLeft2 += content;
                        }
                    });

                    editHeaders.forEach((item) => {
                        const cellClass = item.format === 'date' ? 'date-picker'
                                       : item.format === 'time' ? 'time-picker'
                                       : '';

                        const showClearIcon = item.format === 'time' && item.cell.trim() !== '';

                        let content = `
                            <div class="mb-3 d-flex align-items-center w-100">
                                <label class="p-2 text-center text-truncate d-flex justify-content-center align-items-center m-0 mr-2 w-50 bg-success h-100" style="border-radius: 0.25rem;">${item.header}</label>
                                <div class="position-relative w-100">
                                    <input type="text" class="form-control edit-input ${cellClass} bg-white" name="${item.header}" value="${item.cell || ''}">
                                    ${item.format === 'time' ? `
                                    <span class="time-clear-icon position-absolute${showClearIcon ? '' : ' d-none'}"
                                          style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999;">
                                        <i class="fas fa-times-circle"></i>
                                    </span>` : ''}
                                </div>
                            </div>
                        `;
                        colRight += content;
                    });

                    colLeft1 += '</div>';
                    colLeft2 += '</div>';
                    colRight += '</div>';

                    rowHTML += `
                        <div class="row col-12 col-lg-6 col-xl-9">
                            ${colLeft1}
                            ${colLeft2}
                        </div>
                        <div class="row col-12 col-lg-6 col-xl-3">
                            ${colRight}
                        </div>
                    `;

                    showDataDiv.append(rowHTML);

                    flatpickr(".date-picker", {
                        locale: "ja",
                        dateFormat: "Y/m/d",
                    });

                    flatpickr(".time-picker", {
                        locale: "ja",
                        enableTime: true,
                        noCalendar: true,
                        dateFormat: "H:i",
                        time_24hr: true,
                    });
                });

                function UpdateFormatData(Input) {
                    const dataIndex = $('.show-data').attr('data-index');
                    const fieldName = Input.attr('name');
                    const fieldValue = Input.val();

                    const postData = {
                        key: dataIndex,
                        field_name: fieldName,
                        field_value: fieldValue,
                        csrfmiddlewaretoken: getCookie('csrftoken')
                    };

                    $.ajax({
                        url: "{% url 'update_format_data' %}",
                        type: "POST",
                        data: postData,
                        error: function (error) {
                            createToast('error', 'データ送信中にエラーが発生しました。');
                        }
                    });
                }
                $(document).ready(function() {
                    $(document).on('input', '.time-picker', function() {
                        const clearIcon = $(this).siblings('.time-clear-icon');
                        if ($(this).val().trim() !== '') {
                            clearIcon.removeClass('d-none');
                        } else {
                            clearIcon.addClass('d-none');
                        }
                    });
                    $(document).on('click', '.time-clear-icon', function() {
                        const input = $(this).siblings('.time-picker');
                        input.val('');
                        $(this).addClass('d-none');

                        input.trigger('change');
                    });
                });

                $('<style>')
                .prop('type', 'text/css')
                .html(`
                    .time-clear-icon {
                        opacity: 0.7;
                        transition: opacity 0.2s;
                        z-index: 10;
                    }
                    .time-clear-icon:hover {
                        opacity: 1;
                    }
                    .time-picker {
                        padding-right: 30px;
                    }
                `)
                .appendTo('head');


                $(document).on('blur change', '.edit-input', function () {
                    UpdateFormatData($(this));
                });

                $(document).on('change', 'input[type="radio"]', function () {
                    const name = $(this).attr('name');
                    const selectedDate = $(this).closest('div').find('input[type="text"]').val();
                    $(".date-picker").val(selectedDate);
                    const formattedKey = $('.show-data').attr('data-index');
                    const targetRow = $(`#inputData tbody tr[data-index="${formattedKey}"]`);
                    targetRow.find('td.row-date').text(selectedDate);

                    $(`input[name="${name}"]`).not(this).prop('checked', false);
                    UpdateFormatData($(".date-picker"));
                });

                $(document).on('change', '.edit-input', function () {
                    const newText = $(this).val();
                    const name = $(this).attr('name');
                    const formattedKey = $('.show-data').attr('data-index');
                    const targetRow = $(`#inputData tbody tr[data-index="${formattedKey}"]`);

                    targetRow.find(`td.${name}`).text(newText);
                });

                $(".btn-export").on('click', function () {
                    if (this.attributes.id.value === 'system-csv') {
                        window.location.href = "{% url 'download' 'kenkoshisutemu' %}";
                    } else {
                        window.location.href = "{% url 'download' 'yoyaku_daikou' %}";
                    }
                });
            });

            $(document).ready(function() {
                let isResizing = false;
                let startY, startHeight;
                const minHeight = 200;
                let maxHeight = window.innerHeight * 0.8;

                function setupResizeHandle() {
                    $('.table-resize-handle').remove();

                    if ($('.dataTables_scrollBody').length) {
                        $('.table-responsive').css('position', 'relative');
                        $('<div class="table-resize-handle"></div>').appendTo('.table-responsive');

                        $('.table-resize-handle').css({
                            'position': 'absolute',
                            'bottom': '0',
                            'left': '0',
                            'right': '0',
                            'height': '10px',
                            'background-color': 'transparent',
                            'cursor': 'ns-resize',
                            'z-index': '100'
                        });

                        initResizeEvents();
                    }
                }

                function initResizeEvents() {
                    $('.table-resize-handle').on('mousedown', function(e) {
                        isResizing = true;
                        startY = e.clientY;
                        startHeight = $('.dataTables_scrollBody').height();

                        $('body').append('<div id="resize-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;cursor:ns-resize;"></div>');

                        $('.dataTables_scrollBody').addClass('resize-active');

                        e.preventDefault();
                    });

                    $(document).on('mousemove', function(e) {
                        if (!isResizing) return;

                        const newHeight = startHeight + (e.clientY - startY);

                        if (newHeight >= minHeight && newHeight <= maxHeight) {
                            $('.dataTables_scrollBody').height(newHeight);

                            adjustDataContainer();
                            if ($.fn.DataTable.isDataTable("#inputData")) {
                                $("#inputData").DataTable().columns.adjust();
                            }
                        }
                    });

                    $(document).on('mouseup', function() {
                        if (isResizing) {
                            isResizing = false;
                            $('#resize-overlay').remove();
                            $('.dataTables_scrollBody').removeClass('resize-active');

                            const newHeight = $('.dataTables_scrollBody').height();
                            localStorage.setItem('preferredTableHeight', newHeight);
                        }
                    });
                }

                function adjustDataContainer() {
                    const scrollBodyHeight = $('.dataTables_scrollBody').height();
                    const tableContainerHeight = scrollBodyHeight + 150;

                    const windowHeight = window.innerHeight;
                    const tableOffset = $('.table-responsive').offset().top;
                    const footerHeight = 50;

                    const availableSpace = windowHeight - tableOffset - footerHeight;
                    $('.show-data').parent().css('height', `${Math.max(200, availableSpace)}px`);
                }

                function applyStoredHeight() {
                    const storedHeight = localStorage.getItem('preferredTableHeight');
                    if (storedHeight && $('.dataTables_scrollBody').length) {
                        $('.dataTables_scrollBody').height(parseInt(storedHeight));
                        adjustDataContainer();
                    }
                }

                function handleTableSetup() {
                    if ($('.dataTables_scrollBody').length) {
                        setupResizeHandle();
                        applyStoredHeight();
                        adjustDataContainer();
                    } else {
                        setTimeout(handleTableSetup, 500);
                    }
                }

                handleTableSetup();

                $(window).on('resize', function() {
                    if ($('.dataTables_scrollBody').length) {
                        maxHeight = window.innerHeight * 0.8;

                        const currentHeight = $('.dataTables_scrollBody').height();
                        if (currentHeight > maxHeight) {
                            $('.dataTables_scrollBody').height(maxHeight);
                        }

                        adjustDataContainer();
                    }
                });

                $('<style>')
                    .prop('type', 'text/css')
                    .html(`
                        .dataTables_scrollBody {
                            transition: height 0.1s ease;
                            border-bottom: 1px solid #e3e6f0;
                        }
                        .dataTables_scrollBody.resize-active {
                            border-bottom: 2px solid #4e73df;
                        }
                        .table-resize-handle:hover {
                            background-color: rgba(78, 115, 223, 0.3);
                        }
                    `)
                    .appendTo('head');
            });
        </script>
    {% elif tab == 'upload-file' %}
        <script src="{% static 'web/js/drag-drop-files.js' %}"></script>
    {% endif %}
{% endblock javascripts %}
