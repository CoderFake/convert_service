{% extends 'web/layouts/base.html' %}
{% load static %}
{% load i18n %}
{% block title %} 変換ルール設定 {% endblock title %}

{% block stylesheets %}
    <link rel="stylesheet" type="text/css"
          href="{% static 'web/vendor/datatables.net/css/dataTables.bootstrap5.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'web/css/toggle.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'web/css/error-form.css' %}"/>
    <style>
        .filter-row {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .filter-row label {
            margin-bottom: 0;
            margin-right: 0.5rem;
            font-weight: 500;
        }
        .filter-row .form-select {
            min-width: 150px;
            height: 40px;
            color: #525f7f;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e3e6f0;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #5e72e4;
        }

        .filter-row .form-select, .dataTables_wrapper .row:first-child input{
            height: 40px;
            border-radius: 0.375rem !important;
            border: 1px solid #efefef !important;
        }

        .filter-row #fileFormatSelect{
            min-width: 160px;
        }

        .filter-row #fromToTypeSelect{
            min-width: 340px;
        }

        .format-badge {
            font-size: 85%;
            font-weight: normal;
            padding: 3px 6px;
            border-radius: 3px;
        }

        .bg-light{
            background: #efefef !important;
        }

        .badge-excel {
            background-color: #1D6F42;
            color: white;
        }
        .badge-csv {
            background-color: #4F81BD;
            color: white;
        }
        .dataTables_filter, .dataTables_length{
            width: 100% !important;
            display: flex;
            justify-content: start;
            align-content: center;
        }

        .dataTables_length{
            justify-content: end;
        }

        .dataTables_length select{
            height: 40px;
            width: 60px !important;
            background: none;
            border-radius: 0.375rem !important;
            border: 1px solid #e9ecef !important;
        }

        .dataTables_wrapper .row label{
            margin-bottom: 0;
        }

        .dataTables_wrapper .row:first-child input{
            margin: 0 !important;
            padding: 5px;
            width: 450px !important;
        }

        .dataTables_wrapper input:focus,
        .dataTables_wrapper select:focus{
            outline: none;
        }

        .dataTables_filter label:before {
            content: '' !important;
        }

        #fixedRuleTable th:last-child,
        #fixedRuleTable td:last-child {
            width: 100px;
            text-align: center;
        }

        #fixedRuleTable td:last-child .btn {
            margin-right: 5px;
        }

        #fixedRuleTable td:last-child .btn:last-child {
            margin-right: 0;
        }

        #fixedRuleTable_filter label {
            position: relative;
            z-index: 1;
        }

        .dataTables_info{
            display: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* Modal mở rộng */
        .modal-expandable {
            max-width: 850px;
            transition: max-width 0.3s ease;
        }

        .modal-expanded {
            max-width: 95%;
        }

        /* Phần fixed rule */
        .fixed-rule-section {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .rule-header {
            padding: 15px;
            background-color: #edf2f7;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rule-info {
            display: flex;
            flex-direction: column;
        }

        .rule-info-item {
            margin-bottom: 5px;
        }

        .rule-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-right: 10px;
        }

        .rule-value {
            font-weight: 400;
        }

        .expand-button {
            background-color: #4e73df;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .expand-button:hover {
            background-color: #3756a4;
        }

        .expand-button i {
            transition: transform 0.3s ease;
        }

        .expand-button.expanded i {
            transform: rotate(180deg);
        }

        .fixed-values-section {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .values-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .values-header h5 {
            margin: 0;
        }

        .search-bar {
            position: relative;
            max-width: 300px;
        }

        .search-bar input {
            padding-right: 35px;
        }

        .search-bar .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .values-table {
            margin-top: 15px;
        }

        .values-table th, .values-table td {
            vertical-align: middle;
        }

        .values-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .btn-group-actions {
            display: flex;
            gap: 10px;
        }

        .custom-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .custom-pagination .btn {
            padding: 0.25rem 0.5rem;
            height: 30px;
        }

        .batch-actions {
            display: none;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
            align-items: center;
        }

        .batch-actions.visible {
            display: flex;
        }

        .batch-actions .selected-count {
            margin-right: 15px;
            font-weight: 500;
        }

        .batch-actions .btn-group {
            display: flex;
            gap: 10px;
        }

        .modal-expandable {
            max-width: 850px;
            transition: max-width 1s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: auto;
            margin-right: auto;
        }

        .modal-expanded {
            max-width: 95%;
        }

        #fixedValuesSectionCol {
            opacity: 0;
            transform: translateX(-50px);
            transition: opacity 0.3s ease, transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        #fixedValuesSectionCol.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .modal-body .row {
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .expand-button i {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .expand-button.expanded i {
            transform: rotate(180deg);
        }

    </style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow mt-6">
                <div class="card-body pt-3">
                    <div class="container-fluid mb-3" style="padding: 0 !important;">
                        <div class="row">
                            {% include "web/settings/includes/tab.html" %}
                            <div class="col-3">
                                <div class="d-flex justify-content-end">
                                    <button id="addFixedRuleBtn" class="btn btn-primary px-5 border-0 rounded rounded-3">追加</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive mt-3 position-relative">
                        <div id="tableLoadingOverlay" class="loading-overlay">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <table class="table table-bordered" id="fixedRuleTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>変換ルール</th>
                                    <th>変換ロジック</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">削除確認</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>このアイテムを削除しますが、よろしいでしょうか？</p>
                <p class="text-danger font-weight-bold">この操作は元に戻せません。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">削除</button>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Rule Modal -->
<div class="modal fade" id="fixedRuleModal" tabindex="-1" role="dialog" aria-labelledby="fixedRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-expandable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fixedRuleModalLabel">固定変換ルール管理</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12" id="fixedRuleSectionCol">
                        <div class="fixed-rule-section">
                            <div class="rule-header">
                                <div class="rule-info">
                                    <div class="rule-info-item">
                                        <span class="rule-title">変換ルール:</span>
                                        <span class="rule-value conversion-rule-label">予約時間-受付時間終了</span>
                                    </div>
                                    <div class="rule-info-item">
                                        <span class="rule-title">変換ロジック:</span>
                                        <span class="rule-value conversion-logic-label">ふくおか公衆衛生用変換 (顧客名-団体番号1)</span>
                                    </div>
                                </div>
                                <button type="button" class="expand-button" id="expandValuesBtn">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>

                            <form id="fixedRuleForm">
                                {% csrf_token %}
                                <input type="hidden" id="editRuleId" name="rule_id">
                                <input type="hidden" id="file-format-id" name="file_format_id" value="">

                                <div class="form-group">
                                    <label for="ruleName">ルール名</label>
                                    <input type="text" class="form-control" id="ruleName" name="rule_name">
                                    <div class="invalid-feedback" id="rule_name_error"></div>
                                </div>

                                <div class="form-group mt-3">
                                    <label for="ruleCategory">ルールカテゴリ</label>
                                    <select class="form-control" id="ruleCategory" name="rule_category">
                                        <option value="">カテゴリを選択してください</option>
                                        {% for category in rule_categories %}
                                            <option value="{{ category.id }}">{{ category.convert_rule_category_name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback" id="rule_category_error"></div>
                                </div>

                                <div class="form-group mt-3">
                                    <label for="ruleDescription">ルールの説明</label>
                                    <textarea class="form-control" id="ruleDescription" name="rule_description" rows="3"></textarea>
                                    <div class="invalid-feedback" id="rule_description_error"></div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="col-md-6" id="fixedValuesSectionCol" style="display: none;">
                        <div class="fixed-values-section">
                            <div class="values-header">
                                <h5>変換値のリスト</h5>
                                <div class="search-bar">
                                    <input type="text" id="valueSearchInput" class="form-control" placeholder="値を検索...">
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                            </div>

                            <!-- Batch actions -->
                            <div class="batch-actions" id="batchActionsPanel">
                                <span class="selected-count">0 個の項目が選択されました</span>
                                <div class="btn-group">
                                    <button class="btn btn-danger" id="deleteSelectedBtn">
                                        <i class="fas fa-trash-alt"></i> 選択項目を削除
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive values-table">
                                <table class="table table-bordered table-hover">
                                    <thead class="bg-info text-white">
                                        <tr>
                                            <th style="width: 50px;">
                                                <input type="checkbox" id="selectAllValues">
                                            </th>
                                            <th style="width: 80px;">No.</th>
                                            <th>変換前データ値</th>
                                            <th>変換後データ値</th>
                                            <th style="width: 80px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fixedValuesTableBody">
                                    </tbody>
                                </table>
                            </div>

                            <div class="values-actions">
                                <button class="btn btn-primary" id="addRowBtn">
                                    <i class="fas fa-plus"></i> 行を追加
                                </button>

                                <div class="custom-pagination">
                                    <button class="btn btn-sm btn-outline-primary prev-page">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span class="mx-2 pagination-info">ページ 1/1</span>
                                    <button class="btn btn-sm btn-outline-primary next-page">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="saveFixedRule">ルールを保存</button>
                    <button type="button" class="btn btn-success" id="saveFixedValues" style="display: none;">値を保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="{% static 'web/vendor/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script>
$(document).ready(function() {
    let fixedRuleTable;
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 10;
    let currentItems = [];
    let allItems = [];
    let selectedRuleId = null;

    try {
        fixedRuleTable = $('#fixedRuleTable').DataTable({
            processing: true,
            serverSide: true,
            ordering: false,
            ajax: {
                url: "/settings/fixed-data/",
                type: "GET",
                beforeSend: function() {
                    $('#tableLoadingOverlay').show();
                },
                complete: function() {
                    $('#tableLoadingOverlay').hide();
                },
                error: function(xhr, error, thrown) {
                    $('#tableLoadingOverlay').hide();
                    createToast('error', 'データの読み込み中にエラーが発生しました。');
                }
            },
            columns: [
                {
                    data: "no",
                    name: "no",
                    searchable: false
                },
                { data: "convert_rule_id", name: "convert_rule_id" },
                { data: "convert_rule_name", name: "convert_rule_name" },
                {
                    data: "id",
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-info btn-sm edit-item" data-id="${data}" data-rule-id="${row.rule_id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-item" data-id="${data}">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    }
                },
            ],
            language: {
                url: "/static/web/vendor/datatables.net/language/ja.json",
                search: "_INPUT_",
                searchPlaceholder: "検索..."
            },
            dom: '<"row"<"col-md-6"f><"col-md-6 page-length d-flex align-items-center justify-content-end"l>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, '全て']],
            pageLength: 10,
            drawCallback: function() {
                $('#fixedRuleTable thead tr').find('th').first().text('No.');
            },
            initComplete: function() {
                $('#fixedRuleTable_filter').hide();
                $('#fixedRuleTable_wrapper .row').addClass('mb-4');
                $('#fixedRuleTable_wrapper .row:first-child .col-md-6:first-child').html('')
                .append(`
                    <input class="search-input" type="search" name="search_input" placeholder="キーワード入力" aria-controls="fixedRuleTable">
                    <span class='content position-absolute' style="font-size: 0.7rem; bottom: -22px; left: 1px">検索条件： 変換前のデータ値・変換後のデータ値・変換ルール</span>
                `);
            }
        });
    } catch (e) {
        console.error('Error initializing table:', e);
        createToast('error', 'テーブルの初期化中にエラーが発生しました。');
    }

    $(document).on('keypress', '.search-input', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            const searchValue = $(this).val();
            fixedRuleTable.search(searchValue).draw();
        }
    });
    $('#valueSearchInput').on('keyup', function() {
        const keyword = $(this).val().toLowerCase();
        filterModalItems(keyword);
    });
    $('#addFixedRuleBtn').on('click', function() {
        openAddRuleModal();
    });
    $('#fixedRuleTable tbody').on('click', '.edit-item', function() {
        const itemId = $(this).data('id');
        const ruleId = $(this).data('rule-id');
        selectedRuleId = ruleId;
        loadFixedDataItems(ruleId);
    });
    $('#fixedRuleTable tbody').on('click', '.delete-item', function() {
        const itemId = $(this).data('id');
        prepareDeleteModal(itemId);
    });
    $('#expandValuesBtn').on('click', function() {
        toggleFixedValuesSection();
    });
    $('#addRowBtn').on('click', function() {
        addNewRow();
    });
    $(document).on('click', '.delete-value-btn', function() {
        $(this).closest('tr').remove();
        renumberRows();
        updateSelectedCount();
    });
    $('#selectAllValues').on('change', function() {
        const isChecked = $(this).prop('checked');
        $('#fixedValuesTableBody input[type="checkbox"]').prop('checked', isChecked);
        updateSelectedCount();
        toggleBatchActionsPanel();
    });
    $(document).on('change', '#fixedValuesTableBody input[type="checkbox"]', function() {
        updateSelectedCount();
        toggleBatchActionsPanel();
        const allChecked = $('#fixedValuesTableBody input[type="checkbox"]').length ===
                          $('#fixedValuesTableBody input[type="checkbox"]:checked').length;
        $('#selectAllValues').prop('checked', allChecked);
    });
    $('#deleteSelectedBtn').on('click', function() {
        deleteSelectedRows();
    });
    $('#saveFixedRule').on('click', function() {
        saveFixedRule();
    });
    $('#saveFixedValues').on('click', function() {
        saveFixedValues();
    });
    $('.prev-page').on('click', function() {
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    });

    $('.next-page').on('click', function() {
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    });
    function openAddRuleModal() {
        resetModalForms();
        $('#fixedRuleModal .modal-dialog').removeClass('modal-expanded');
        $('#fixedRuleSectionCol').removeClass('col-md-6').addClass('col-12');
        $('#expandValuesBtn').removeClass('expanded');

        $('#fixedRuleModal').modal('show');
        $('#fixedValuesSectionCol').hide();
        $('#saveFixedRule').show();
        $('#saveFixedValues').hide();
    }

    function resetModalForms() {
        $('#fixedRuleForm')[0].reset();
        $('#editRuleId').val('');
        $('.invalid-feedback').empty();
        $('.is-invalid').removeClass('is-invalid');
        $('#fixedValuesTableBody').empty();
        currentItems = [];
        allItems = [];
        currentPage = 1;
        updatePaginationInfo();
        $('#valueSearchInput').val('');
        $('#batchActionsPanel').hide();
        $('#selectAllValues').prop('checked', false);
    }

    function toggleFixedValuesSection() {
        const valuesSection = $('#fixedValuesSectionCol');
        const expandButton = $('#expandValuesBtn');
        const modal = $('#fixedRuleModal .modal-dialog');

        if (valuesSection.hasClass('visible')) {
            valuesSection.removeClass('visible');

            valuesSection.hide();
            $('#fixedRuleSectionCol').removeClass('col-md-6').addClass('col-12');
            $('#saveFixedValues').hide();

            modal.removeClass('modal-expanded');
            expandButton.removeClass('expanded');

        } else {
            modal.addClass('modal-expanded');
            expandButton.addClass('expanded');

            $('#fixedRuleSectionCol').removeClass('col-12').addClass('col-md-6');

            valuesSection.show();

            setTimeout(() => {
                valuesSection.addClass('visible');
                $('#saveFixedValues').show();
            }, 50);

        }
    }

    function loadFixedDataItems(ruleId) {
        resetModalForms();
        $('#editRuleId').val(ruleId);
        $('#tableLoadingOverlay').show();

        $.ajax({
            url: `/settings/fixed-data-detail/${ruleId}/`,
            type: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.status === 'success') {
                    const ruleData = response.data;
                    $('#ruleName').val(ruleData.rule_name || '');
                    $('#ruleCategory').val(ruleData.rule_category_id || '');
                    $('#ruleDescription').val(ruleData.rule_description || '');
                    $('.conversion-rule-label').text(ruleData.rule_name || '予約時間-受付時間終了');
                    $('.conversion-logic-label').text(ruleData.rule_category || 'ふくおか公衆衛生用変換');
                    allItems = ruleData.items.map(item => ({
                        'id': item.id,
                        'before': item.data_value_before,
                        'after': item.data_value_after
                    }));

                    totalPages = Math.ceil(allItems.length / pageSize) || 1;
                    goToPage(1);
                    updatePaginationInfo();
                    $('#fixedRuleModal .modal-title').text('固定データ編集');
                    $('#fixedRuleModal').modal('show');
                    if (allItems.length > 0 && !$('#fixedValuesSectionCol').is(':visible')) {
                        setTimeout(() => {
                            toggleFixedValuesSection();
                        }, 300);
                    }
                } else {
                    createToast('error', response.message || 'データの読み込み中にエラーが発生しました。');
                }
            },
            error: function(xhr) {
                let errorMsg = 'データの読み込み中にエラーが発生しました。';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {}
                createToast('error', errorMsg);
            },
            complete: function() {
                $('#tableLoadingOverlay').hide();
            }
        });
    }

    function goToPage(page) {
        currentPage = page;
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        currentItems = allItems.slice(startIndex, endIndex);
        renderItems();
        updatePaginationInfo();
    }

    function updatePaginationInfo() {
        $('.pagination-info').text(`ページ ${currentPage}/${totalPages}`);
        $('.prev-page').prop('disabled', currentPage === 1);
        $('.next-page').prop('disabled', currentPage === totalPages);
    }

    function renderItems() {
        $('#fixedValuesTableBody').empty();
        if (currentItems.length === 0) {
            if (allItems.length === 0) {
                addNewRow();
            } else {
                $('#fixedValuesTableBody').append(`
                    <tr>
                        <td colspan="5" class="text-center">表示するデータがありません</td>
                    </tr>
                `);
            }
        } else {
            currentItems.forEach(function(item, index) {
                const rowIndex = (currentPage - 1) * pageSize + index + 1;
                addTableRow(rowIndex, item.id, item.before, item.after);
            });
        }
    }

    function addTableRow(rowIndex, itemId, beforeValue = '', afterValue = '') {
        const row = `
            <tr data-id="${itemId || ''}">
                <td class="text-center">
                    <input type="checkbox" class="value-checkbox">
                </td>
                <td class="text-center">${rowIndex}</td>
                <td>
                    <input type="text" class="form-control before-value" value="${beforeValue || ''}">
                </td>
                <td>
                    <input type="text" class="form-control after-value" value="${afterValue || ''}">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger delete-value-btn">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        `;
        $('#fixedValuesTableBody').append(row);
    }

    function addNewRow(beforeValue = '', afterValue = '') {
        if ($('#fixedValuesTableBody tr').length === 1 && $('#fixedValuesTableBody tr td').length === 1) {
            $('#fixedValuesTableBody').empty();
        }

        const rowCount = $('#fixedValuesTableBody tr').length + 1;
        addTableRow(rowCount, '', beforeValue, afterValue);
        updateSelectedCount();
    }

    function renumberRows() {
        $('#fixedValuesTableBody tr').each(function(index) {
            $(this).find('td:eq(1)').text(index + 1);
        });
    }

    function filterModalItems(keyword) {
        if (!keyword) {
            if (window.originalItems) {
                allItems = [...window.originalItems];
            }
        } else {
            if (!window.originalItems) {
                window.originalItems = [...allItems];
            }
            allItems = window.originalItems.filter(item =>
                (item.before && item.before.toLowerCase().includes(keyword)) ||
                (item.after && item.after.toLowerCase().includes(keyword))
            );
        }
        totalPages = Math.ceil(allItems.length / pageSize) || 1;
        goToPage(1);
    }

    function updateSelectedCount() {
        const selectedCount = $('#fixedValuesTableBody input[type="checkbox"]:checked').length;
        $('.selected-count').text(`${selectedCount} 個の項目が選択されました`);
        toggleBatchActionsPanel();
    }

    function toggleBatchActionsPanel() {
        const selectedCount = $('#fixedValuesTableBody input[type="checkbox"]:checked').length;
        if (selectedCount > 0) {
            $('#batchActionsPanel').addClass('visible').show();
        } else {
            $('#batchActionsPanel').removeClass('visible').hide();
        }
    }

    function deleteSelectedRows() {
        const selectedRows = $('#fixedValuesTableBody input[type="checkbox"]:checked').closest('tr');
        selectedRows.remove();
        renumberRows();
        updateSelectedCount();
        const selectedIds = [];
        selectedRows.each(function() {
            const id = $(this).data('id');
            if (id) {
                selectedIds.push(id);
            }
        });

        if (selectedIds.length > 0) {
            allItems = allItems.filter(item => !selectedIds.includes(item.id));
            totalPages = Math.ceil(allItems.length / pageSize) || 1;
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            goToPage(currentPage);
        }
    }

    function prepareDeleteModal(itemId) {
        $('#confirmDelete').data('id', itemId);
        $('#deleteModal').modal('show');
    }

    $('#confirmDelete').on('click', function() {
        const itemId = $(this).data('id');
        deleteFixedDataItem(itemId);
    });

    function deleteFixedDataItem(itemId) {
        $.ajax({
            url: `/settings/fixed-data-delete/${itemId}/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#deleteModal').modal('hide');
                if (response.status === 'success') {
                    createToast('success', response.message || '削除に成功しました。');
                    fixedRuleTable.ajax.reload();
                } else {
                    createToast('error', response.message || '削除中にエラーが発生しました。');
                }
            },
            error: function() {
                $('#deleteModal').modal('hide');
                createToast('error', '削除中にエラーが発生しました。');
            }
        });
    }

    function saveFixedRule() {
        const ruleId = $('#editRuleId').val();
        const ruleName = $('#ruleName').val();
        const ruleCategory = $('#ruleCategory').val();
        const ruleDescription = $('#ruleDescription').val();

        if (!ruleName || !ruleCategory) {
            if (!ruleName) {
                $('#ruleName').addClass('is-invalid');
                $('#rule_name_error').text('このフィールドは必須です。');
            }
            if (!ruleCategory) {
                $('#ruleCategory').addClass('is-invalid');
                $('#rule_category_error').text('このフィールドは必須です。');
            }
            return;
        }

        const saveBtn = $('#saveFixedRule');
        const saveBtnText = saveBtn.html();
        saveBtn.html('<span class="spinner-border spinner-border-sm" role="status"></span> 保存中...');
        saveBtn.prop('disabled', true);

        const url = ruleId ? `/settings/fixed-rule-update/${ruleId}/` : '/settings/fixed-rule-create/';
        $.ajax({
            url: url,
            type: 'POST',
            data: {
                rule_id: ruleId,
                rule_name: ruleName,
                rule_category: ruleCategory,
                rule_description: ruleDescription,
                csrfmiddlewaretoken: getCookie('csrftoken')
            },
            success: function(response) {
                if (response.status === 'success') {
                    createToast('success', response.message || '保存に成功しました。');
                    if (!ruleId && response.data && response.data.rule_id) {
                        $('#editRuleId').val(response.data.rule_id);
                        selectedRuleId = response.data.rule_id;
                    }
                    if (!$('#fixedValuesSectionCol').is(':visible')) {
                        setTimeout(() => {
                            toggleFixedValuesSection();
                        }, 100);
                    }
                    setTimeout(() => {
                        $('#fixedValuesTableBody tr:first-child .before-value').focus();
                    }, 300);
                } else {
                    if (response.errors) {
                        displayFormErrors(response.errors);
                    } else {
                        createToast('error', response.message || '保存中にエラーが発生しました。');
                    }
                }
            },
            error: function(xhr) {
                let errorMsg = '保存中にエラーが発生しました。';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.errors) {
                        displayFormErrors(response.errors);
                        return;
                    } else if (response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {}
                createToast('error', errorMsg);
            },
            complete: function() {
                saveBtn.html(saveBtnText);
                saveBtn.prop('disabled', false);
            }
        });
    }

    function saveFixedValues() {
        saveCurrentPageItems();

        const ruleId = $('#editRuleId').val();
        if (!ruleId) {
            createToast('error', '最初にルールを保存してください。');
            return;
        }

        const allDataItems = collectAllFixedValues();

        const saveBtn = $('#saveFixedValues');
        const saveBtnText = saveBtn.html();
        saveBtn.html('<span class="spinner-border spinner-border-sm" role="status"></span> 保存中...');
        saveBtn.prop('disabled', true);

        $.ajax({
            url: '/settings/fixed-data-batch-save/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                rule_id: ruleId,
                items: allDataItems
            }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.status === 'success') {
                    createToast('success', response.message || '保存に成功しました。');
                    loadFixedDataItems(ruleId);
                } else {
                    if (response.errors) {
                        displayFormErrors(response.errors);
                    } else {
                        createToast('error', response.message || '保存中にエラーが発生しました。');
                    }
                }
            },
            error: function(xhr) {
                let errorMsg = '保存中にエラーが発生しました。';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.errors) {
                        displayFormErrors(response.errors);
                        return;
                    } else if (response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {}
                createToast('error', errorMsg);
            },
            complete: function() {
                saveBtn.html(saveBtnText);
                saveBtn.prop('disabled', false);
            }
        });
    }

    function saveCurrentPageItems() {
        $('#fixedValuesTableBody tr').each(function(index) {
            const rowId = $(this).data('id');
            const beforeValue = $(this).find('.before-value').val();
            const afterValue = $(this).find('.after-value').val();

            if (beforeValue && afterValue) {
                const itemIndex = (currentPage - 1) * pageSize + index;
                if (rowId && itemIndex < allItems.length) {
                    allItems[itemIndex].before = beforeValue;
                    allItems[itemIndex].after = afterValue;
                } else if (beforeValue && afterValue) {
                    allItems.push({
                        'id': null, // Will be assigned by the server
                        'before': beforeValue,
                        'after': afterValue
                    });
                }
            }
        });

        totalPages = Math.ceil(allItems.length / pageSize) || 1;
    }

    function collectAllFixedValues() {
        saveCurrentPageItems();
        return allItems.filter(item => item.before && item.after).map(item => ({
            'id': item.id || null,
            'before': item.before,
            'after': item.after
        }));
    }

    function displayFormErrors(errors) {
        $('.invalid-feedback').empty();
        $('.is-invalid').removeClass('is-invalid');

        for (const field in errors) {
            const errorMsg = errors[field];
            const errorElement = $(`#${field}_error`);

            if (errorElement.length) {
                errorElement.text(errorMsg);
                errorElement.closest('.form-group').find('input, select, textarea').addClass('is-invalid');
            } else if (field === 'items') {
                createToast('error', errorMsg);
            }
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock javascripts %}