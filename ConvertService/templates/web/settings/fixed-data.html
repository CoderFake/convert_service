{% extends 'web/layouts/base.html' %}
{% load static %}
{% load i18n %}
{% block title %} 変換ルール設定 {% endblock title %}

{% block stylesheets %}
    <link rel="stylesheet" type="text/css"
          href="{% static 'web/vendor/datatables.net/css/dataTables.bootstrap5.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'web/css/toggle.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'web/css/error-form.css' %}"/>
    <style>
        .filter-row {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .filter-row label {
            margin-bottom: 0;
            margin-right: 0.5rem;
            font-weight: 500;
        }
        .filter-row .form-select {
            min-width: 150px;
            height: 40px;
            color: #525f7f;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e3e6f0;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #5e72e4;
        }

        .filter-row .form-select, .dataTables_wrapper .row:first-child input{
            height: 40px;
            border-radius: 0.375rem !important;
            border: 1px solid #efefef !important;
        }

        .bg-light{
            background: #efefef !important;
        }

        .dataTables_filter, .dataTables_length{
            width: 100% !important;
            display: flex;
            justify-content: start;
            align-content: center;
        }

        .dataTables_length{
            justify-content: end;
        }

        .dataTables_length select{
            height: 40px;
            width: 60px !important;
            background: none;
            border-radius: 0.375rem !important;
            border: 1px solid #e9ecef !important;
        }

        .dataTables_wrapper .row label{
            margin-bottom: 0;
        }

        .dataTables_wrapper .row:first-child input{
            margin: 0 !important;
            padding: 5px;
            width: 450px !important;
        }

        .dataTables_wrapper input:focus,
        .dataTables_wrapper select:focus{
            outline: none;
        }

        .dataTables_filter label:before {
            content: '' !important;
        }

        #fixedRuleTable th:last-child,
        #fixedRuleTable td:last-child {
            width: 100px;
            text-align: center;
        }

        #fixedRuleTable td:last-child .btn {
            margin-right: 5px;
        }

        #fixedRuleTable td:last-child .btn:last-child {
            margin-right: 0;
        }

        #fixedValuesTableBody td {
            padding: 5px 5px;
        }

        #fixedRuleModal .form-control{
            height: calc(1.2em + 1.25rem);
        }

        .dataTables_info{
            display: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .modal-expandable {
            max-width: 850px;
            transition: max-width 0.3s ease;
        }

        .modal-expanded {
            max-width: 95%;
        }

        #fixedValuesSectionCol {
            opacity: 0;
            transform: translateX(-50px);
            transition: opacity 0.3s ease, transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        #fixedValuesSectionCol.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .modal-body .row {
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .expand-button i {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .expand-button.expanded i {
            transform: rotate(180deg);
        }

        .fixed-data, .fixed-values-container{
            max-height: 490px;
        }

        .fixed-values-section {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .values-table th, .values-table td {
            vertical-align: middle;
        }

        .custom-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .custom-pagination .btn {
            padding: 0.25rem 0.5rem;
            height: 30px;
        }

        .add-fixed-value-row {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .remove-row-btn {
            margin-top: 32px;
        }

    </style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow mt-6">
                <div class="card-body pt-3">
                    <div class="container-fluid mb-3" style="padding: 0 !important;">
                        <div class="row">
                            {% include "web/settings/includes/tab.html" %}
                            <div class="col-3">
                                <div class="d-flex justify-content-end">
                                    <button id="addFixedRuleBtn" class="btn btn-primary px-5 border-0 rounded rounded-3">追加</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive mt-3 position-relative">
                        <div id="tableLoadingOverlay" class="loading-overlay">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <table class="table table-bordered" id="fixedRuleTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>変換ルール</th>
                                    <th>変換ロジック</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">削除確認</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>このアイテムを削除しますが、よろしいでしょうか？</p>
                <p class="text-danger font-weight-bold">この操作は元に戻せません。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">削除</button>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Rule Modal -->
<div class="modal fade" id="fixedRuleModal" tabindex="-1" role="dialog" aria-labelledby="fixedRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-expandable" role="document">
        <div class="modal-content">
            <form id="fixedRuleForm">
                {% csrf_token %}
                <input type="hidden" id="editRuleId" name="rule_id">
                <input type="hidden" id="file-format-id" name="file_format_id" value="">

                <div class="modal-header">
                    <h5 class="modal-title" id="fixedRuleModalLabel">固定変換ルール管理</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-12" id="fixedRuleSectionCol">
                            <div class="form-group row">
                                <label for="ruleFixedId" class="col-sm-3 col-form-label">変換ルール</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="ruleFixedId" name="rule_fixed_id">
                                    <div class="invalid-feedback" id="rule_fixed_id_error"></div>
                                </div>
                            </div>

                            <div class="form-group row mt-3">
                                <label for="ruleName" class="col-sm-3 col-form-label">変換ロジック</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="ruleName" name="rule_name">
                                    <div class="invalid-feedback" id="rule_name_error"></div>
                                </div>
                            </div>

                            <input type="hidden" id="ruleCategory" name="rule_category" value="2">

                            <div class="mt-4" id="add-fixed-values-section">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <button type="button" class="btn btn-primary btn-sm add-new-value-row">
                                        <i class="fas fa-plus"></i> 入力行を追加
                                    </button>
                                </div>
                                <div class="fixed-data overflow-hidden w-100">
                                    <div class="fixed-values-container overflow-auto">
                                </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6" id="fixedValuesSectionCol" style="display: none;">

                            <div class="fixed-values-section">
                                <div class="search-fixed-data mb-3">
                                    <input type="search" class="form-control" placeholder="キーワード入力">
                                </div>
                                <div class="table-responsive values-table">
                                    <table class="table table-bordered table-hover">
                                        <thead class="bg-primary text-white">
                                            <tr>
                                                <th style="width: 40px;">No.</th>
                                                <th>変換前データ値</th>
                                                <th>変換後データ値</th>
                                                <th style="width: 80px;">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fixedValuesTableBody">
                                        </tbody>
                                    </table>
                                </div>

                                <div class="values-actions">
                                    <div class="custom-pagination">
                                        <button class="btn btn-sm btn-outline-primary prev-page" type="button">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="mx-2 pagination-info">ページ 1/1</span>
                                        <button class="btn btn-sm btn-outline-primary next-page" type="button">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-primary" id="saveFixedRule">ルールを保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="{% static 'web/vendor/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script>
$(document).ready(function() {
    let fixedRuleTable;
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 10;
    let currentItems = [];
    let allItems = [];
    let selectedRuleId = null;
    let isEditing = false;

    try {
        fixedRuleTable = $('#fixedRuleTable').DataTable({
            processing: true,
            serverSide: true,
            ordering: false,
            ajax: {
                url: "/settings/fixed-data/",
                type: "GET",
                beforeSend: function() {
                    $('#tableLoadingOverlay').show();
                },
                complete: function() {
                    $('#tableLoadingOverlay').hide();
                },
                error: function(xhr, error, thrown) {
                    $('#tableLoadingOverlay').hide();
                    createToast('error', 'データの読み込み中にエラーが発生しました。');
                }
            },
            columns: [
                {
                    data: "no",
                    name: "no",
                    searchable: false
                },
                { data: "convert_rule_id", name: "convert_rule_id" },
                { data: "convert_rule_name", name: "convert_rule_name" },
                {
                    data: "id",
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-info btn-sm edit-item" data-id="${data}" data-rule-id="${row.rule_id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-item" data-id="${data}">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    }
                },
            ],
            language: {
                url: "/static/web/vendor/datatables.net/language/ja.json",
                search: "_INPUT_",
                searchPlaceholder: "検索..."
            },
            dom: '<"row"<"col-md-6"f><"col-md-6 page-length d-flex align-items-center justify-content-end"l>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, '全て']],
            pageLength: 10
        });
    } catch (e) {
        console.error('Error initializing table:', e);
        createToast('error', 'テーブルの初期化中にエラーが発生しました。');
    }

    $('#addFixedRuleBtn').on('click', function() {
        openAddRuleModal();
    });

    $('#fixedRuleTable tbody').on('click', '.edit-item', function() {
        const itemId = $(this).data('id');
        const ruleId = $(this).data('rule-id');
        selectedRuleId = ruleId;
        isEditing = true;
        loadFixedDataItems(ruleId);
    });

    $('#fixedRuleTable tbody').on('click', '.delete-item', function() {
        const itemId = $(this).data('id');
        prepareDeleteModal(itemId);
    });

    // Add new fixed value row
    $(document).on('click', '.add-new-value-row', function() {
        addNewFixedValueRow();
    });

    // Remove fixed value row
    $(document).on('click', '.remove-row-btn', function() {
        $(this).closest('.add-fixed-value-row').remove();
        updateFixedValueRowNumbers();
    });

    // Form submit handler
    $('#fixedRuleForm').on('submit', function(e) {
        e.preventDefault();
        if (validateForm()) {
            saveFixedRule();
        }
    });

    // Expand values section
    $(document).on('click', '#expandValuesBtn', function() {
        toggleFixedValuesSection();
    });

    // Inline edit in table
    $(document).on('blur', '.inline-edit', function() {
        const $tr = $(this).closest('tr');
        const itemId = $tr.data('id');
        const beforeValue = $tr.find('.before-value-edit').val();
        const afterValue = $tr.find('.after-value-edit').val();
        saveInlineEdit(itemId, beforeValue, afterValue);
    });

    // Pagination controls
    $(document).on('click', '.prev-page', function() {
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    });

    $(document).on('click', '.next-page', function() {
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    });

    // Delete fixed value from table
    $(document).on('click', '.delete-fixed-value', function() {
        const itemId = $(this).data('id');
        deleteFixedValue(itemId);
    });

    // Functions
    function openAddRuleModal() {
        resetModalForms();
        isEditing = false;
        selectedRuleId = null;

        $('#expandValuesBtn').hide();
        $('#fixedValuesSectionCol').hide().removeClass('visible');
        $('#fixedRuleModal .modal-dialog').removeClass('modal-expanded');
        $('#fixedRuleSectionCol').removeClass('col-md-6').addClass('col-12');

        addNewFixedValueRow();

        $('#fixedRuleModal .modal-title').text('固定データ追加');

        $('#fixedRuleModal').modal('show');
    }

    function resetModalForms() {
        $('#fixedRuleForm')[0].reset();
        $('#editRuleId').val('');
        $('.invalid-feedback').empty();
        $('.is-invalid').removeClass('is-invalid');
        $('#fixedValuesTableBody').empty();
        $('.fixed-values-container').empty();
        currentItems = [];
        allItems = [];
        currentPage = 1;
        updatePaginationInfo();
    }

    function addNewFixedValueRow() {
        const rowCount = $('.fixed-values-container .add-fixed-value-row').length + 1;
        const rowHtml = `
            <div class="add-fixed-value-row">
                <div class="form-row">
                    <div class="col-md-5">
                        <div class="form-group">
                            <label>変換前データ値 ${rowCount}</label>
                            <input type="text" class="form-control before-value" name="before_value[]">
                            <div class="invalid-feedback before-value-error"></div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label>変換後データ値 ${rowCount}</label>
                            <input type="text" class="form-control after-value" name="after_value[]">
                            <div class="invalid-feedback after-value-error"></div>
                        </div>
                    </div>
                    <div class="col-md-2 pt-2 my-auto">
                        <button type="button" class="btn btn-danger btn-sm remove-row-btn pt-1 my-auto">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('.fixed-values-container').append(rowHtml);
        const container = $('.fixed-values-container')[0];
        container.scrollTo({
            top: container.scrollHeight,
            behavior: 'smooth'
        });
    }

    function updateFixedValueRowNumbers() {
        $('.add-fixed-value-row').each(function(index) {
            $(this).find('label:contains("変換前データ値")').text('変換前データ値 ' + (index + 1));
            $(this).find('label:contains("変換後データ値")').text('変換後データ値 ' + (index + 1));
        });
    }

    function loadFixedDataItems(ruleId) {
        resetModalForms();
        $('#editRuleId').val(ruleId);

        $('#expandValuesBtn').show();
        $('#fixedValuesSectionCol').show().addClass('visible');
        $('#fixedRuleModal .modal-dialog').addClass('modal-expanded');
        $('#fixedRuleSectionCol').removeClass('col-12').addClass('col-md-6');

        $.ajax({
            url: `/settings/fixed-data-detail/${ruleId}/`,
            type: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.status === 'success') {
                    const ruleData = response.data;

                    $('#ruleFixedId').val(ruleData.rule_fixed_id || '');
                    $('#ruleName').val(ruleData.rule_name || '');

                    // Load existing fixed values
                    allItems = ruleData.items.map(item => ({
                        'id': item.id,
                        'before': item.data_value_before,
                        'after': item.data_value_after
                    }));

                    totalPages = Math.ceil(allItems.length / pageSize) || 1;
                    goToPage(1);
                    updatePaginationInfo();

                    // Add new fixed value rows
                    addNewFixedValueRow();

                    $('#fixedRuleModal .modal-title').text('固定データ編集');
                    $('#fixedRuleModal').modal('show');
                }
            }
        });
    }

    function toggleFixedValuesSection() {
        const valuesSection = $('#fixedValuesSectionCol');
        const expandButton = $('#expandValuesBtn');
        const modal = $('#fixedRuleModal .modal-dialog');

        if (valuesSection.hasClass('visible')) {
            valuesSection.removeClass('visible');
            valuesSection.hide();
            $('#fixedRuleSectionCol').removeClass('col-md-6').addClass('col-12');
            modal.removeClass('modal-expanded');
            expandButton.removeClass('expanded');
        } else {
            modal.addClass('modal-expanded');
            expandButton.addClass('expanded');
            $('#fixedRuleSectionCol').removeClass('col-12').addClass('col-md-6');
            valuesSection.show();
            setTimeout(() => {
                valuesSection.addClass('visible');
            }, 50);
        }
    }

    function validateForm() {
        let isValid = true;
        $('.invalid-feedback').empty();
        $('.is-invalid').removeClass('is-invalid');

        // Validate rule name
        const ruleFixedId = $('#ruleFixedId').val().trim();
        if (!ruleFixedId) {
            $('#ruleFixedId').addClass('is-invalid');
            $('#rule_fixed_id_error').text('このフィールドは必須です。');
            isValid = false;
        }

        // Validate rule description
        const ruleName = $('#ruleName').val().trim();
        if (!ruleName) {
            $('#ruleName').addClass('is-invalid');
            $('#rule_name_error').text('このフィールドは必須です。');
            isValid = false;
        }

        // Validate fixed values
        let hasValidFixedValue = false;
        const beforeValues = new Set(allItems.map(item => item.before)); // Include existing items

        $('.add-fixed-value-row').each(function() {
            const beforeValue = $(this).find('.before-value').val().trim();
            const afterValue = $(this).find('.after-value').val().trim();

            if (beforeValue || afterValue) {
                if (!beforeValue) {
                    $(this).find('.before-value').addClass('is-invalid');
                    $(this).find('.before-value-error').text('このフィールドは必須です。');
                    isValid = false;
                } else if (beforeValues.has(beforeValue)) {
                    $(this).find('.before-value').addClass('is-invalid');
                    $(this).find('.before-value-error').text('変換前データ値が重複しています。');
                    isValid = false;
                } else {
                    beforeValues.add(beforeValue);
                }

                if (!afterValue) {
                    $(this).find('.after-value').addClass('is-invalid');
                    $(this).find('.after-value-error').text('このフィールドは必須です。');
                    isValid = false;
                }

                if (beforeValue && afterValue) {
                    hasValidFixedValue = true;
                }
            }
        });

        return isValid && hasValidFixedValue;
    }

    function saveFixedRule() {
        const ruleId = $('#editRuleId').val();
        const ruleFixedId = $('#ruleFixedId').val().trim();
        const ruleName = $('#ruleName').val().trim();
        const ruleCategory = $('#ruleCategory').val();

        // Collect fixed values
        const fixedValues = [];
        $('.add-fixed-value-row').each(function() {
            const beforeValue = $(this).find('.before-value').val().trim();
            const afterValue = $(this).find('.after-value').val().trim();

            if (beforeValue && afterValue) {
                fixedValues.push({
                    'before': beforeValue,
                    'after': afterValue
                });
            }
        });

        const saveBtn = $('#saveFixedRule');
        const saveBtnText = saveBtn.html();
        saveBtn.html('<span class="spinner-border spinner-border-sm" role="status"></span> 保存中...');
        saveBtn.prop('disabled', true);

        const url = ruleId ? `/settings/fixed-rule-update/${ruleId}/` : '/settings/fixed-rule-create/';
        $.ajax({
            url: url,
            type: 'POST',
            data: {
                rule_id: ruleId,
                rule_fixed_id: ruleFixedId,
                rule_category: ruleCategory,
                rule_name: ruleName,
                csrfmiddlewaretoken: getCookie('csrftoken')
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Save fixed values if any
                    if (fixedValues.length > 0) {
                        const ruleIdToUse = ruleId || response.data.rule_id;
                        saveFixedValues(ruleIdToUse, fixedValues);
                    } else {
                        createToast('success', response.message || '保存に成功しました。');
                        $('#fixedRuleModal').modal('hide');
                        fixedRuleTable.ajax.reload();
                    }
                } else {
                    displayFormErrors(response.errors);
                }
            },
            error: function(xhr) {
                let errorMsg = '保存中にエラーが発生しました。';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.errors) {
                        displayFormErrors(response.errors);
                        return;
                    } else if (response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {}
                createToast('error', errorMsg);
            },
            complete: function() {
                saveBtn.html(saveBtnText);
                saveBtn.prop('disabled', false);
            }
        });
    }

    function saveFixedValues(ruleId, items) {
        $.ajax({
            url: '/settings/fixed-data-batch-save/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                rule_id: ruleId,
                items: items
            }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.status === 'success') {
                    createToast('success', response.message || '保存に成功しました。');
                    $('#fixedRuleModal').modal('hide');
                    fixedRuleTable.ajax.reload();
                } else {
                    displayFormErrors(response.errors);
                }
            },
            error: function(xhr) {
                createToast('error', '固定値の保存中にエラーが発生しました。');
            }
        });
    }

    function goToPage(page) {
        currentPage = page;
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        currentItems = allItems.slice(startIndex, endIndex);
        renderItems();
        updatePaginationInfo();
    }

    function updatePaginationInfo() {
        $('.pagination-info').text(`ページ ${currentPage}/${totalPages}`);
        $('.prev-page').prop('disabled', currentPage === 1);
        $('.next-page').prop('disabled', currentPage === totalPages);
    }

    function renderItems() {
        $('#fixedValuesTableBody').empty();
        currentItems.forEach(function(item, index) {
            const rowIndex = (currentPage - 1) * pageSize + index + 1;
            addTableRow(rowIndex, item.id, item.before, item.after);
        });
    }

    function addTableRow(rowIndex, itemId, beforeValue = '', afterValue = '') {
        const row = `
            <tr data-id="${itemId || ''}">
                <td>${rowIndex}</td>
                <td><input type="text" class="form-control inline-edit before-value-edit" value="${beforeValue}" /></td>
                <td><input type="text" class="form-control inline-edit after-value-edit" value="${afterValue}" /></td>
                <td>
                    <button class="btn btn-danger btn-sm delete-fixed-value" data-id="${itemId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        $('#fixedValuesTableBody').append(row);
    }

    function saveInlineEdit(itemId, beforeValue, afterValue) {
        if (!beforeValue || !afterValue) {
            createToast('error', '変換前データ値と変換後データ値は必須です。');
            return;
        }

        // Check for duplicate beforeValue
        const otherBeforeValues = allItems
            .filter(item => item.id !== itemId)
            .map(item => item.before);
        if (otherBeforeValues.includes(beforeValue)) {
            createToast('error', '変換前データ値が重複しています。');
            return;
        }

        $.ajax({
            url: '/settings/fixed-data-batch-save/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                rule_id: selectedRuleId,
                items: [{ id: itemId, before: beforeValue, after: afterValue }]
            }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update local data
                    const item = allItems.find(item => item.id === itemId);
                    if (item) {
                        item.before = beforeValue;
                        item.after = afterValue;
                    }
                    goToPage(currentPage); // Refresh table
                    createToast('success', '固定値が更新されました。');
                } else {
                    createToast('error', response.message || '更新に失敗しました。');
                }
            },
            error: function() {
                createToast('error', '固定値の更新中にエラーが発生しました。');
            }
        });
    }

    function deleteFixedValue(itemId) {
        if (!confirm('この固定値を削除しますか？')) return;

        $.ajax({
            url: `/settings/fixed-data-delete/${itemId}/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Remove from local data
                    allItems = allItems.filter(item => item.id !== itemId);
                    totalPages = Math.ceil(allItems.length / pageSize) || 1;
                    if (currentPage > totalPages) currentPage = totalPages;
                    goToPage(currentPage);
                    createToast('success', response.message || '固定値が削除されました。');
                } else {
                    createToast('error', response.message || '削除に失敗しました。');
                }
            },
            error: function() {
                createToast('error', '固定値の削除中にエラーが発生しました。');
            }
        });
    }

    function prepareDeleteModal(itemId) {
        $('#deleteModal').modal('show');
        $('#confirmDelete').off('click').on('click', function() {
            $.ajax({
                url: `/settings/fixed-data-delete/${itemId}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        createToast('success', response.message);
                        fixedRuleTable.ajax.reload();
                        $('#deleteModal').modal('hide');
                    } else {
                        createToast('error', response.message);
                    }
                },
                error: function(xhr) {
                    createToast('error', '削除中にエラーが発生しました。');
                }
            });
        });
    }

    function displayFormErrors(errors) {
        for (const [field, message] of Object.entries(errors)) {
            $(`#${field}_error`).text(message).show();
            $(`#${field}`).addClass('is-invalid');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock javascripts %}